# Avatype STUN/TURN Server - HARDENED Configuration
# Security Level: Production-Ready
# Last Updated: 2024

# ===========================================
# Network Configuration
# ===========================================
listening-port=3478
tls-listening-port=5349
listening-ip=0.0.0.0
relay-ip=0.0.0.0
min-port=49152
max-port=49252

# ===========================================
# Server Identity
# ===========================================
realm=turn.avatype.com
server-name=avatype-turn

# IMPORTANT: Don't reveal software version
no-software-attribute

# ===========================================
# Authentication (CRITICAL)
# ===========================================
# Use time-limited credentials (HMAC-SHA1)
use-auth-secret
lt-cred-mech

# Reject requests without authentication
no-anonymous

# Nonce timeout (prevents replay attacks)
stale-nonce=600

# ===========================================
# TLS/DTLS Security (CRITICAL)
# ===========================================
# Disable old TLS versions
no-tlsv1
no-tlsv1_1

# Strong cipher suites only (TLS 1.2+)
cipher-list="ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256"

# DH parameters length (minimum 2048)
dh2066

# Enable DTLS for media encryption
# (WebRTC uses DTLS-SRTP, this ensures it's enforced)

# ===========================================
# Rate Limiting & Quotas (DDoS Protection)
# ===========================================
# Max bandwidth per session (5 Mbps)
max-bps=5000000

# Total server bandwidth capacity (100 Mbps)
bps-capacity=100000000

# Per-user session limits
user-quota=12
total-quota=1200

# Limit allocation lifetime (10 minutes max)
max-allocate-lifetime=600

# Channel lifetime
channel-lifetime=600

# Permission lifetime  
permission-lifetime=300

# ===========================================
# Connection Limits
# ===========================================
# Max users per realm
max-users=1000

# Allocation timeout
allocation-default-lifetime=600

# ===========================================
# Security Hardening (CRITICAL)
# ===========================================
# Prevent relay to loopback and multicast
no-loopback-peers
no-multicast-peers

# Block ALL private/reserved IP ranges
# RFC 1918 Private Networks
denied-peer-ip=10.0.0.0-10.255.255.255
denied-peer-ip=172.16.0.0-172.31.255.255
denied-peer-ip=192.168.0.0-192.168.255.255

# Loopback
denied-peer-ip=127.0.0.0-127.255.255.255

# Link-local
denied-peer-ip=169.254.0.0-169.254.255.255

# CGNAT (Carrier-grade NAT)
denied-peer-ip=100.64.0.0-100.127.255.255

# Documentation ranges (should never be routed)
denied-peer-ip=192.0.2.0-192.0.2.255
denied-peer-ip=198.51.100.0-198.51.100.255
denied-peer-ip=203.0.113.0-203.0.113.255

# Benchmarking
denied-peer-ip=198.18.0.0-198.19.255.255

# Reserved for IETF
denied-peer-ip=192.0.0.0-192.0.0.255

# 6to4 Relay Anycast
denied-peer-ip=192.88.99.0-192.88.99.255

# Reserved/Broadcast
denied-peer-ip=0.0.0.0-0.255.255.255
denied-peer-ip=224.0.0.0-239.255.255.255
denied-peer-ip=240.0.0.0-255.255.255.255

# Prevent relay amplification attacks
# Only allow relay to public internet
check-origin-consistency

# Require fingerprint attribute (RFC 5389)
fingerprint

# Enable mobility (ICE Mobility)
mobility

# ===========================================
# Logging (Security Monitoring)
# ===========================================
log-file=stdout
simple-log

# Enable for debugging, disable in production
# verbose

# Log binding requests (useful for detecting scans)
log-binding

# ===========================================
# CLI Disabled (Attack Surface Reduction)
# ===========================================
no-cli

# ===========================================
# Additional Hardening
# ===========================================
# Require secure connection for credential exchange
# (Forces TURNS for actual relay - optional, breaks some clients)
# secure-stun

# Respond to STUN binding even on TURN port
# (Helps with connectivity but safe since binding reveals only public IP)
respond-to-stun-binding

# ===========================================
# Fly.io Specific
# ===========================================
# External IP is set via command line by entrypoint.sh
# Process credentials securely via command line args
