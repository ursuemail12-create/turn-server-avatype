# Fly.io Application Configuration
app = "avatype-turn"
primary_region = "iad"  # Virginia, USA

kill_signal = "SIGINT"
kill_timeout = 5

[build]
  dockerfile = "Dockerfile"

[env]
  # Coturn environment variables
  COTURN_EXTERNAL_IP = ""  # Will be auto-detected
  COTURN_REALM = "avatype.com"
  COTURN_MIN_PORT = "49152"
  COTURN_MAX_PORT = "65535"
  # Authentication
  COTURN_USER = "avatype"
  COTURN_PASSWORD = "changeme_strong_password_here"

# HTTP health check endpoint (optional)
[http_service]
  internal_port = 3478
  force_https = false
  auto_stop_machines = true
  auto_start_machines = true
  min_machines_running = 1
  processes = ["app"]

# UDP Service for STUN/TURN
[[services]]
  internal_port = 3478
  protocol = "udp"
  auto_stop_machines = false
  
  [[services.ports]]
    port = 3478
    handlers = []
  
  [[services.tcp_checks]]
    interval = 15000
    timeout = 2000
    grace_period = "5s"

# TCP Service for STUN/TURN (fallback)
[[services]]
  internal_port = 3478
  protocol = "tcp"
  
  [[services.ports]]
    port = 3478
    handlers = []
  
  [[services.tcp_checks]]
    interval = 15000
    timeout = 2000
    grace_period = "5s"

# TLS Service (optional, for secure TURN)
[[services]]
  internal_port = 5349
  protocol = "tcp"
  
  [[services.ports]]
    port = 5349
    handlers = ["tls"]
  
  [[services.tcp_checks]]
    interval = 15000
    timeout = 2000
    grace_period = "5s"

# Dynamic UDP ports for media relay
[[services]]
  internal_port = 49152
  protocol = "udp"
  auto_stop_machines = false
  
  [[services.ports]]
    port = 49152
    end_port = 65535
    handlers = []
  
  [[services.tcp_checks]]
    interval = 30000
    timeout = 5000
    grace_period = "10s"

# Add more regions for global deployment (optional)
# [[services]]
#   internal_port = 3478
#   protocol = "udp"
#   [[services.ports]]
#     port = 3478
#   processes = ["app"]
#   [services.concurrency]
#     type = "connections"
#     hard_limit = 100
#     soft_limit = 50

[deploy]
  strategy = "rolling"
  max_unavailable = 0
  wait_time = 30

[mounts]
  source = "turn_data"
  destination = "/var/lib/coturn"