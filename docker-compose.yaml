version: '3.8'

# Avatype STUN/TURN Server - Local Development
# Run with: docker-compose up -d

services:
  coturn:
    build: .
    container_name: avatype-turn
    restart: unless-stopped
    
    # Network mode host is recommended for TURN servers
    # to avoid NAT issues with UDP
    network_mode: "host"
    
    # Alternative: use port mappings (may have NAT issues)
    # ports:
    #   - "3478:3478/udp"
    #   - "3478:3478/tcp"
    #   - "5349:5349/tcp"
    #   - "49152-49252:49152-49252/udp"
    
    environment:
      # Generate a secure secret for production!
      - TURN_AUTH_SECRET=${TURN_AUTH_SECRET:-development-secret-change-me}
      - TURN_REALM=${TURN_REALM:-turn.avatype.local}
      - TURN_MIN_PORT=49152
      - TURN_MAX_PORT=49252
    
    volumes:
      - coturn-data:/var/lib/coturn
    
    healthcheck:
      test: ["/healthcheck.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

volumes:
  coturn-data:

# ===========================================
# Usage:
# ===========================================
# 
# Start server:
#   docker-compose up -d
#
# View logs:
#   docker-compose logs -f coturn
#
# Stop server:
#   docker-compose down
#
# Test STUN (requires stun client):
#   stun localhost
#
# ===========================================
# For production, create a .env file:
# ===========================================
#
# TURN_AUTH_SECRET=your-secure-random-secret
# TURN_REALM=turn.yourdomain.com
#
